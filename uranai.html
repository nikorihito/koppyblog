<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä»Šæ—¥ã®ãƒ‹ã‚³ãƒªå ã„</title>
  <link rel="stylesheet" href="../style.css" />
  <link rel="icon" href="https://nikorihito.github.io/koppyblog/favicon.png" type="image/png">

  <style>
    body {
      text-align: center;
      font-family: sans-serif;
      padding: 20px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 20px;
      background-color: #4ec1f5;
      color: #fff;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 700;
      transition: transform 0.08s ease, background-color 0.3s;
      margin-top: 16px;
      border: none;
      cursor: pointer;
    }
    .btn:hover { background-color: #38a3d1; }
    .btn:active { transform: translateY(1px); }
    .btn.secondary {
      background-color: #e9f6ff;
      color: #147aa3;
      border: 1px solid #bfe7fb;
    }
    .btn.secondary:hover { background-color: #d8f0ff; }

    #resultBox {
      margin-top: 18px;
      padding: 14px 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #fafafa;
      display: inline-block;
      min-width: min(520px, 92vw);
    }

    #result {
      font-size: 1.6em;
      font-weight: 800;
      margin: 6px 0 0;
    }

    #meta {
      margin: 0;
      color: #6b7280;
      font-size: 0.95em;
    }

    .tag {
      display: inline-block;
      margin-top: 10px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.9em;
      font-weight: 700;
    }
    .tag.good { background: #e8fff1; color: #0b7a3a; border: 1px solid #bff2d2; }
    .tag.ok   { background: #eaf7ff; color: #0b5d86; border: 1px solid #c8ebff; }
    .tag.mid  { background: #f4f4f5; color: #3f3f46; border: 1px solid #e4e4e7; }
    .tag.warn { background: #fff7e6; color: #8a5a00; border: 1px solid #ffe0a6; }
    .tag.bad  { background: #ffecec; color: #a10000; border: 1px solid #ffc6c6; }

    .actions {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    .hidden { display: none; }
  </style>
</head>

<body>
  <header>
    <a href="../index.html">
      <img src="./favicon.png" alt="ã‚µã‚¤ãƒˆãƒ­ã‚´" class="logo" />
    </a>
    <h1>ã“ã£ã´ãƒ¼ã®ãƒã‚¤ã‚¯ãƒ©ã²ã¨ã‚„ã™ã¿</h1>
    <p class="subtitle">ã‚†ã‚‹ã£ã¨æ°—ã¾ã¾ã«ã€ãƒã‚¤ã‚¯ãƒ©ã®ã“ã¨ã‚’æ›¸ã„ã¦ã¾ã™ã€‚youtubeã®é…å¸ƒç‰©ã‚‚è¼‰ã›ã¾ã™ã€‚</p>
  </header>

  <main>
    <h2>ğŸ”® ä»Šæ—¥ã®ãƒ‹ã‚³ãƒªå ã„</h2>
    <p>ä»Šæ—¥ã®é‹å‹¢ã‚’å ã£ã¦ã¿ã‚ˆã†ï¼</p>

    <button id="fortuneBtn" class="btn" type="button" onclick="uranau()">
      å ã†ï¼
    </button>

    <div id="resultBox" class="hidden" aria-live="polite" aria-atomic="true">
      <p id="meta"></p>
      <div id="tag" class="tag mid">---</div>
      <p id="result"></p>

      <div class="actions">
        <button class="btn secondary" type="button" onclick="copyResult()">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
        <a id="shareX" class="btn secondary" target="_blank" rel="noopener">Xã§å…±æœ‰</a>
        <button class="btn secondary" type="button" onclick="resetToday()">ä»Šæ—¥ã®çµæœã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <a href="./index.html" class="btn secondary">â† ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
  </main>

  <footer>
    <p>&copy; 2025 ã“ã£ã´ãƒ¼</p>
  </footer>

  <script>
    // 1) çµæœãƒªã‚¹ãƒˆã‚’ã€Œãƒ†ã‚­ã‚¹ãƒˆï¼‹ãƒ©ãƒ³ã‚¯ã€ã§ç®¡ç†ï¼ˆè¦‹ãŸç›®ã‚„å…±æœ‰æ–‡ã«ä½¿ã„ã‚„ã™ã„ï¼‰
    const results = [
      { text: "è¶…ãƒ©ãƒƒã‚­ãƒ¼ï¼ğŸ‰", rank: "good", label: "å¤§å‰" },
      { text: "ã¾ã‚ã¾ã‚ã„ã„æ„Ÿã˜ğŸ˜Š", rank: "ok",   label: "å‰" },
      { text: "ãµã¤ã†ã€œ",         rank: "mid",  label: "ä¸­å‰" },
      { text: "ã¡ã‚‡ã£ã¨æ³¨æ„âš ï¸",   rank: "warn", label: "æœ«å‰" },
      { text: "ã ã‚ã‹ã‚‚â€¦ğŸ˜¢",      rank: "bad",  label: "å‡¶" }
    ];

    const STORAGE_KEY = "nikori_fortune_v1";

    function yyyyMMddJST(d = new Date()) {
      // GitHub Pagesã§ã‚‚ã‚ºãƒ¬ã«ãã„ã‚ˆã†ã«ã€æ—¥æœ¬æ™‚é–“ã§æ—¥ä»˜ã‚­ãƒ¼ã‚’ä½œã‚‹
      const jst = new Date(d.toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" }));
      const y = jst.getFullYear();
      const m = String(jst.getMonth() + 1).padStart(2, "0");
      const day = String(jst.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    // 2) â€œä»Šæ—¥ã®çµæœã¯å›ºå®šâ€ã«ã™ã‚‹ãŸã‚ã€æ—¥ä»˜ã‹ã‚‰æ“¬ä¼¼ä¹±æ•°ã§ index ã‚’æ±ºã‚ã‚‹
    // ï¼ˆåŒã˜æ—¥ãªã‚‰åŒã˜indexã«ãªã‚‹ï¼‰
    function seededIndexByDate(dateKey, length) {
      let h = 2166136261;
      for (let i = 0; i < dateKey.length; i++) {
        h ^= dateKey.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return Math.abs(h) % length;
    }

    function setUI(data, dateKey) {
      const box = document.getElementById("resultBox");
      const meta = document.getElementById("meta");
      const tag = document.getElementById("tag");
      const result = document.getElementById("result");

      box.classList.remove("hidden");
      meta.textContent = `ğŸ“… ${dateKey} ã®é‹å‹¢`;
      tag.className = `tag ${data.rank}`;
      tag.textContent = data.label;
      result.textContent = data.text;

      // Xå…±æœ‰ãƒªãƒ³ã‚¯ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã€‚URLã‚’è¼‰ã›ãŸã„ãªã‚‰ location.href ã‚’å…¥ã‚Œã¦ã‚‚OKï¼‰
      const share = document.getElementById("shareX");
      const shareText = `ä»Šæ—¥ã®ãƒ‹ã‚³ãƒªå ã„ï¼š${data.label}ï¼ˆ${data.text}ï¼‰ #ã“ã£ã´ãƒ¼ã®ãƒã‚¤ã‚¯ãƒ©ã²ã¨ã‚„ã™ã¿`;
      share.href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`;
    }

    function loadToday() {
      const dateKey = yyyyMMddJST();
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) return null;

      try {
        const obj = JSON.parse(saved);
        if (obj.dateKey === dateKey && obj.index != null) {
          return { dateKey, index: obj.index };
        }
      } catch (_) {}
      return null;
    }

    function saveToday(index) {
      const dateKey = yyyyMMddJST();
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ dateKey, index }));
      return dateKey;
    }

    // 3) å ã†ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ¼”å‡ºâ†’çµæœè¡¨ç¤ºï¼‰
    function uranau() {
      const btn = document.getElementById("fortuneBtn");
      btn.disabled = true;

      const dateKey = yyyyMMddJST();
      const today = loadToday();

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã£ã½ãè¦‹ã›ã‚‹
      btn.textContent = "å ã„ä¸­â€¦ğŸ”®";

      setTimeout(() => {
        let index;
        if (today) {
          index = today.index;
        } else {
          index = seededIndexByDate(dateKey, results.length);
          saveToday(index);
        }

        setUI(results[index], dateKey);

        btn.disabled = false;
        btn.textContent = "ã‚‚ã†ä¸€åº¦è¦‹ã‚‹ï¼ˆä»Šæ—¥ã®çµæœã¯åŒã˜ï¼‰";
      }, 450);
    }

    // 4) ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
    async function copyResult() {
      const dateKey = yyyyMMddJST();
      const today = loadToday();
      if (!today) return;

      const data = results[today.index];
      const text = `${dateKey} ã®ãƒ‹ã‚³ãƒªå ã„ï¼š${data.label}ï¼ˆ${data.text}ï¼‰`;

      try {
        await navigator.clipboard.writeText(text);
        alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
      } catch (e) {
        // clipboardãŒä½¿ãˆãªã„ç’°å¢ƒå‘ã‘ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
      }
    }

    // 5) ãƒ‡ãƒãƒƒã‚°/éŠã³ç”¨ï¼šä»Šæ—¥ã®çµæœã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæœ¬ç•ªã§ã¯æ¶ˆã—ã¦ã‚‚OKï¼‰
    function resetToday() {
      localStorage.removeItem(STORAGE_KEY);
      document.getElementById("fortuneBtn").textContent = "å ã†ï¼";
      document.getElementById("resultBox").classList.add("hidden");
    }

    // 6) ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸç¬é–“ã«ã€Œä»Šæ—¥ã®çµæœã€ãŒã‚ã‚Œã°è¡¨ç¤ºï¼ˆä½“é¨“ãŒè‰¯ã„ï¼‰
    window.addEventListener("DOMContentLoaded", () => {
      const today = loadToday();
      if (today) {
        const dateKey = yyyyMMddJST();
        setUI(results[today.index], dateKey);

        const btn = document.getElementById("fortuneBtn");
        btn.textContent = "ã‚‚ã†ä¸€åº¦è¦‹ã‚‹ï¼ˆä»Šæ—¥ã®çµæœã¯åŒã˜ï¼‰";
      }
    });
  </script>
</body>
</html>
